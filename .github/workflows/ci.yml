name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ‚îÄ‚îÄ test ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify module graph
        run: go mod verify

      - name: go vet
        run: go vet ./...

      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out -json ./... | tee test-results.json
          echo "Exit code: ${PIPESTATUS[0]}"
          test "${PIPESTATUS[0]}" -eq 0

      - name: Enforce 100% coverage on internal/metrics
        run: |
          go test -coverprofile=metrics-coverage.out ./internal/metrics/
          go tool cover -func=metrics-coverage.out | tee metrics-coverage.txt
          TOTAL=$(grep '^total:' metrics-coverage.txt | awk '{print $3}' | tr -d '%')
          echo "internal/metrics coverage: ${TOTAL}%"
          if [ "$TOTAL" != "100.0" ]; then
            echo "::error::internal/metrics coverage is ${TOTAL}%, expected 100.0%"
            exit 1
          fi

      - name: Generate coverage HTML
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Coverage summary
        run: |
          TOTAL=$(go tool cover -func=coverage.out | awk '/^total:/ { print $NF }')
          echo "## üìä Coverage Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Overall Coverage: ${TOTAL}**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Coverage by Package" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          for pkg in cmd/ups-mqtt internal/config internal/metrics internal/nut internal/publisher; do
            if go test -coverprofile=tmp.out ./$pkg/ 2>/dev/null; then
              COV=$(go tool cover -func=tmp.out | awk '/^total:/ { gsub(/%/, "", $NF); print $NF }')
              if [ -n "$COV" ]; then
                FILLED=$(echo "$COV / 10" | bc)
                EMPTY=$((10 - FILLED))
                BAR=""
                for i in $(seq 1 "$FILLED" 2>/dev/null); do BAR+="‚ñà"; done
                for i in $(seq 1 "$EMPTY" 2>/dev/null); do BAR+="‚ñë"; done
                printf "%-24s %s %5.1f%%\n" "$pkg" "$BAR" "$COV" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          done
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          UNCOVERED=$(go tool cover -func=coverage.out | grep -v "100.0%" | grep -v "^total:" || true)
          if [ -n "$UNCOVERED" ]; then
            echo "<details>" >> "$GITHUB_STEP_SUMMARY"
            echo "<summary>‚ö†Ô∏è Functions below 100% coverage</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "$UNCOVERED" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "<details>" >> "$GITHUB_STEP_SUMMARY"
          echo "<summary>üìã Full function coverage</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          go tool cover -func=coverage.out >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Test summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          PASS=$(grep '"Action":"pass"' test-results.json | grep '"Test"' | wc -l | tr -d ' ')
          FAIL=$(grep '"Action":"fail"' test-results.json | grep '"Test"' | wc -l | tr -d ' ')
          SKIP=$(grep '"Action":"skip"' test-results.json | grep '"Test"' | wc -l | tr -d ' ')
          echo "| ‚úÖ Passed | ‚ùå Failed | ‚è≠Ô∏è Skipped |" >> "$GITHUB_STEP_SUMMARY"
          echo "|:--------:|:--------:|:---------:|" >> "$GITHUB_STEP_SUMMARY"
          echo "| $PASS | $FAIL | $SKIP |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "$FAIL" -gt 0 ]; then
            echo "<details open>" >> "$GITHUB_STEP_SUMMARY"
            echo "<summary>‚ùå Failed test output</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            jq -r 'select(.Action=="output") | select(.Test != null) | .Output // empty' \
              test-results.json 2>/dev/null | head -200 >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "<details>" >> "$GITHUB_STEP_SUMMARY"
          echo "<summary>üê¢ Slowest tests (top 10)</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Test | Duration |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|----------|" >> "$GITHUB_STEP_SUMMARY"
          jq -r 'select(.Action=="pass" and .Test != null and .Elapsed != null) |
            "\(.Package | split("/") | .[-1])/\(.Test)|\(.Elapsed)s"' \
            test-results.json 2>/dev/null | sort -t'|' -k2 -rn | head -10 | \
            while IFS='|' read -r test dur; do
              echo "| \`$test\` | $dur |" >> "$GITHUB_STEP_SUMMARY"
            done || true
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.out
            coverage.html
            metrics-coverage.txt
          retention-days: 30

  # ‚îÄ‚îÄ build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build:
    name: Build (${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goarm && format('-arm{0}', matrix.goarm) || '' }})
    runs-on: ubuntu-latest
    needs: test

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            goarm: ""
            suffix: linux-amd64
          - goos: linux
            goarch: arm
            goarm: "6"
            suffix: linux-arm-pi-zero
          - goos: linux
            goarch: arm64
            goarm: ""
            suffix: linux-arm64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: "0"
        run: |
          go build -ldflags="-s -w" -o "ups-mqtt-${{ matrix.suffix }}" ./cmd/ups-mqtt

      - name: Report binary size
        run: |
          SIZE=$(du -sh "ups-mqtt-${{ matrix.suffix }}" | cut -f1)
          echo "Binary \`ups-mqtt-${{ matrix.suffix }}\`: **${SIZE}**" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ups-mqtt-${{ matrix.suffix }}
          path: ups-mqtt-${{ matrix.suffix }}
          retention-days: 90
